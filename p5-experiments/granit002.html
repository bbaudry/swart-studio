<!DOCTYPE html>
<html lang="en">
<html>

<head>
    <meta charset="UTF-8">
    <script src="libraries/p5.js"></script>
    <style>
        body {
            padding: 0;
            margin: 0;
        }
    </style>
</head>

<body>
    <script>
        //global vars for the whole piece
        var w = 900;
        var h = 900;
        var palette = [
            {
                back: [0, 0, 100],
                ray: [330, 80, 100, 84],
                city: [50, 100, 100]
            },
            {
                back: [0, 0, 0],
                ray: [0, 100, 100, 84],
                city: [0, 0, 100]
            },
            {
                back: [0, 0, 0],
                ray: [0, 0, 100, 84],
                city: [0, 100, 100]
            },
            {
                back: [230, 100, 50],
                ray: [50, 100, 100, 84],
                city: [330, 100, 100]
            }
        ]
        var back_color, ray_color, city_color


        function setup() {
            createCanvas(w, h);
            colorMode(HSB, 360, 100, 100, 250);
            choose_color()
            set_sections()
            strokeCap(SQUARE)
            console.log("there are " + sections.length + " sections")
        }

        function choose_color() {
            let c = Math.floor(random(palette.length))
            back_color = palette[c].back
            ray_color = palette[c].ray
            city_color = palette[c].city
        }

        function draw() {
            //background(back_color[0], back_color[1], back_color[2]);
            //stroke(ray_color[0], ray_color[1], ray_color[2]);
            //fill(city_color[0], city_color[1], city_color[2]);
            background(230, 100, 50)
            fill(50,0,0)
            stroke(0,0,100)
            sections.sort(() => random() - 0.5);
            //stripes(30,30,400,30,400,400,30,400)
            //quad(30,30,400,30,400,400,30,400)
            draw_sections()
            noLoop();
        }

        function draw_sections() {
            for (vera in sections) {
                strokeWeight((1+random(7)))
                //if(random()>0.5){fill(130,100,100);stroke(330,100,100)}
                //else{fill(180,100,100);stroke(30,100,100)}
                if(random()>0.5){fill(0,0,100);stroke(0,0,0)}
                else{fill(180,0,0);stroke(30,0,100)}
                quad(sections[vera].x1, sections[vera].y1,
                    sections[vera].x2, sections[vera].y2,
                    sections[vera].x3, sections[vera].y3,
                    sections[vera].x4, sections[vera].y4)
                zoom(sections[vera].x1, sections[vera].y1,
                    sections[vera].x2, sections[vera].y2,
                    sections[vera].x3, sections[vera].y3,
                    sections[vera].x4, sections[vera].y4)

            }
        }
        function zoom(x1,y1,x2,y2,x3,y3,x4,y4){
            var off = 7+random(11)
            while (x2-x1>0){
                x1+=off;x2-=off;x3=x2;x4=x1;
                y1+=off;y2=y1;y3-=off;y4=y3;
                quad(x1,y1,x2,y2,x3,y3,x4,y4)
                
            }
        }

        function stripes(x1,y1,x2,y2,x3,y3,x4,y4){
            var ryoji,ikeda
            var off = 21
            if(random()<0.5){
                ryoji = y3-y1
                for(i=0;i<=off;i++){
                    ikeda=y1+i*ryoji/off
                    line(x1,ikeda,x2,ikeda)
                }
            }
            else{
                ryoji = x2-x1
                for(i=0;i<=off;i++){
                    ikeda=x1+i*ryoji/off
                    line(ikeda,y1,ikeda,y3)
                }
            }
        }

        //42,21 default values
        //both values can be in the [7,42]range
        var sectionresolution = 42;
        var maxsizesection = 21;//upper bound when choosing the width and height of a section. 
            
        var pad = 21
        var wmin = pad
        var hmin = pad
        var wmax = w - pad
        var hmax = h - pad
        var sections = []
        function set_sections() {
            noFill()
            stroke(city_color[0], city_color[1], city_color[2])
            var x1, y1, x2, y2, nbcellsw, nbcellsh, east, miny, maxy, shape;
            x1 = wmin
            y1 = hmin
            miny = wmin
            maxy = hmin
            east = true
            while (east) {
                nbcellsw = 1 + Math.floor(random(maxsizesection))
                nbcellsh = 1 + Math.floor(random(maxsizesection))
                if (y1 + nbcellsh * sectionresolution < miny) {
                    miny = y1 + nbcellsh * sectionresolution
                }
                else {
                    if (y1 + nbcellsh * sectionresolution > maxy) {
                        maxy = y1 + nbcellsh * sectionresolution
                        if (miny == y1) {
                            miny = y1 + nbcellsh * sectionresolution;
                        }
                    }
                }
                if (y1 + nbcellsh * sectionresolution <= hmax) { y2 = y1 + nbcellsh * sectionresolution }
                else { y2 = hmax }
                if (x1 + nbcellsw * sectionresolution < wmax) {
                    x2 = x1 + nbcellsw * sectionresolution
                    //quad(x1, y1, x2, y1, x2, y2, x1, y2); 
                    sections.push({ x1: x1, y1: y1, x2: x2, y2: y1, x3: x2, y3: y2, x4: x1, y4: y2 })
                    x1 += nbcellsw * sectionresolution
                }
                else {
                    x2 = wmax
                    //quad(x1, y1, x2, y1, x2, y2, x1, y2); 
                    sections.push({ x1: x1, y1: y1, x2: x2, y2: y1, x3: x2, y3: y2, x4: x1, y4: y2 })
                    if (miny + nbcellsh * sectionresolution < hmax) {
                        x1 = wmin
                        y1 = miny
                        maxy = miny
                    }
                    else {
                        var last = true
                        x1 = wmin
                        if (miny < hmax) { y1 = miny }
                        y2 = hmax
                        while (last) {
                            nbcellsw = 1 + Math.floor(random(maxsizesection))
                            if (x1 + nbcellsw * sectionresolution < wmax) {
                                x2 = x1 + nbcellsw * sectionresolution
                                //quad(x1, y1, x2, y1, x2, y2, x1, y2); 
                                sections.push({ x1: x1, y1: y1, x2: x2, y2: y1, x3: x2, y3: y2, x4: x1, y4: y2 })
                                x1 += nbcellsw * sectionresolution
                            }
                            else {
                                x2 = wmax
                                //quad(x1, y1, x2, y1, x2, y2, x1, y2); 
                                sections.push({ x1: x1, y1: y1, x2: x2, y2: y1, x3: x2, y3: y2, x4: x1, y4: y2 })
                                last = false
                            }
                        }
                        east = false
                    }
                }
            }
        }


    </script>
</body>

</html>