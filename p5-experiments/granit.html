<!DOCTYPE html>
<html lang="en">
<html>

<head>
    <meta charset="UTF-8">
    <script src="libraries/p5.js"></script>
    <style>
        body {
            padding: 0;
            margin: 0;
        }
    </style>
</head>

<body>
    <script>
        //global vars for the whole piece
        var w = 800;
        var realw = w * 2;
        var h = 800;

        function setup() {
            createCanvas(w, h);
            colorMode(HSB, 360, 100, 100, 250);
            background(230, 100, 50);

        }

        function draw() {
            background(230, 100, 50);
            cadre();
            //citydense(0, 0, w/2, 0, w/2, h/2)
            //citydense(w/2, 0, w, h/2, w, 0)
            //citydense(w/2, h/2, w, h/2, w/2, 0)
            //citydense(w/2, h/2, w/2, h, w, h/2)
            //citydense(w/2, h/2, w/2, h, 0, h/2)
            //densify(0,0,w,h,40)
            //densify(w/2,0,w,h/2,40)
            //save("granit.png")
            noLoop();
        }

        function cadre() {
            stripes(0, 0, w, 0, w, h);
            diveall(0, 0, w, 0, w, h, 0);
            stripes(0, 0, w, h, 0, h);
            diveall(0, 0, w, h, 0, h, 0);
        }

        function corerays(x1, y1, x2, y2, x3, y3) {
            let cx = (x1 + x2 + x3) / 3
            let cy = (y1 + y2 + y3) / 3
            stroke(50, 100, 100, 84)
            let inc = random(0.01, 0.02)
            for (t = 0; t < 1; t += inc) {
                strokeWeight(3)
                px1 = (1 - t) * x2 + (t * x3);
                py1 = (1 - t) * y2 + (t * y3);
                line(cx, cy, px1, py1)
            }
            inc = random(0.01, 0.02)
            for (t = 0; t < 1; t += inc) {
                strokeWeight(3)
                px1 = (1 - t) * x1 + (t * x3);
                py1 = (1 - t) * y1 + (t * y3);
                line(cx, cy, px1, py1)
            }
            inc = random(0.01, 0.02)
            for (t = 0; t < 1; t += inc) {
                strokeWeight(3)
                px1 = (1 - t) * x2 + (t * x1);
                py1 = (1 - t) * y2 + (t * y1);
                line(cx, cy, px1, py1)
            }

        }

        function citydense(x1, y1, x2, y2, x3, y3) {
            let px1, py1, px2, py2, inc, interval;
            stroke(50, 100, 100)
            var corner = Math.floor(random(3));
            switch (corner) {
                case 0: console.log(0)
                    inc = random(0.01, 0.02)
                    if (x1 != x3) { interval = Math.abs(x1 - x3) * inc }
                    else { interval = Math.abs(x1 - x2) * inc }
                    for (t = 0; t < 1; t += inc) {
                        strokeWeight(3)
                        px1 = (1 - t) * x1 + (t * x3);
                        py1 = (1 - t) * y1 + (t * y3);
                        px2 = (1 - t) * x1 + (t * x2);
                        py2 = (1 - t) * y1 + (t * y2);
                        densify(px1, py1, px2, py2, interval)
                    }
                    break;
                case 1:
                    inc = random(0.01, 0.02)
                    if (x2 != x3) { interval = Math.abs(x2 - x3) * inc }
                    else { interval = Math.abs(x1 - x2) * inc }
                    console.log(interval)
                    for (t = 0; t < 1; t += inc) {
                        strokeWeight(3)
                        px1 = (1 - t) * x2 + (t * x3);
                        py1 = (1 - t) * y2 + (t * y3);
                        px2 = (1 - t) * x2 + (t * x1);
                        py2 = (1 - t) * y2 + (t * y1);
                        densify(px1, py1, px2, py2, interval)
                    }
                    break;
                case 2:
                    inc = random(0.01, 0.02)
                    if (x1 != x3) { interval = Math.abs(x1 - x3) * inc }
                    else { interval = Math.abs(x3 - x2) * inc }
                    for (t = 0; t < 1; t += inc) {
                        strokeWeight(3)
                        px1 = (1 - t) * x3 + (t * x1);
                        py1 = (1 - t) * y3 + (t * y1);
                        px2 = (1 - t) * x3 + (t * x2);
                        py2 = (1 - t) * y3 + (t * y2);
                        densify(px1, py1, px2, py2, interval)

                        line(px1, py1, px2, py2)
                    }
                    break;
            }
        }

        function densify(x1, y1, x2, y2, t) {
            let px1, py1, px2, py2, i, j, drop;
            let horizontal = false
            let vertical = false
            let len = Math.sqrt((x1-x2)*(x1-x2)+(y1-y2)*(y1*y2))            
            noStroke()
            px1 = x1
            py1 = y1
            if (x1 == x2) { vertical = true }
            if (y1 == y2) { horizontal = true }
            i=random(3/len,7/len)
            while (i < 1) {
                px2 = (1 - i) * x1 + (i * x2);
                py2 = (1 - i) * y1 + (i * y2);
                drop = t + random(-t/2,t/2);
                fill(330, 100, 100, random(84, 168))
                if (vertical) {
                    quad(px1, py1, px2, py2, px2 + drop, py2, px1 + drop, py1)
                }
                else {
                    if (horizontal) {
                        quad(px1, py1, px2, py2, px2, py2 + drop, px1, py1 + drop)
                    }
                    else {
                            quad(px1, py1, px1 + drop, py1, px2 + drop, py2, px2, py2)
                    }
                }
                px1 = px2
                py1 = py2
                i+=random(3/len,7/len)
            }
        }

        function densifyglitch(x1, y1, x2, y2, t) {
            let px1, py1, px2, py2, i, drop;

            noStroke()
            px1 = x1
            py1 = y1
            i = random(0.01, 0.02)
            while (i < 1) {
                px2 = (1 - i) * x1 + (i * x2);
                py2 = (1 - i) * y1 + (i * y2);
                drop = t + random(t);
                fill(330, 100, 100, random(84, 168))
                rect(px1, py1, px2, py2, px2 + drop, py2 + drop, px1 + drop, py1 + drop)
                i += random(0.01, 0.02)
            }
        }

        function city(x1, y1, x2, y2, x3, y3) {
            let px1, py1, px2, py2, inc;
            stroke(50, 100, 100, 84)
            var corner = Math.floor(random(3));
            switch (corner) {
                case 0:
                    inc = random(0.01, 0.02)
                    for (t = 0; t < 1; t += inc) {
                        strokeWeight(3)
                        px1 = (1 - t) * x1 + (t * x3);
                        py1 = (1 - t) * y1 + (t * y3);
                        px2 = (1 - t) * x1 + (t * x2);
                        py2 = (1 - t) * y1 + (t * y2);
                        line(px1, py1, px2, py2)
                    }
                    break;
                case 1:
                    inc = random(0.01, 0.02)
                    for (t = 0; t < 1; t += inc) {
                        strokeWeight(3)
                        px1 = (1 - t) * x2 + (t * x3);
                        py1 = (1 - t) * y2 + (t * y3);
                        px2 = (1 - t) * x2 + (t * x1);
                        py2 = (1 - t) * y2 + (t * y1);
                        line(px1, py1, px2, py2)
                    }
                    break;
                case 2:
                    inc = random(0.01, 0.02)
                    for (t = 0; t < 1; t += inc) {
                        strokeWeight(3)
                        px1 = (1 - t) * x3 + (t * x1);
                        py1 = (1 - t) * y3 + (t * y1);
                        px2 = (1 - t) * x3 + (t * x2);
                        py2 = (1 - t) * y3 + (t * y2);
                        line(px1, py1, px2, py2)
                    }
                    break;
            }


        }

        function stripes(x1, y1, x2, y2, x3, y3) {
            var corner = Math.floor(random(3));
            switch (corner) {
                case 0:
                    rays(x1, y1, x2, y2, x3, y3);
                    break;
                case 1:
                    rays(x2, y2, x3, y3, x1, y1);
                    break;
                case 2:
                    rays(x3, y3, x2, y2, x1, y1);
                    break;
            }
        }

        function rays(x1, y1, x2, y2, x3, y3) {
            let px1, py1;
            stroke(50, 100, 100, 84)
            let inc = random(0.01, 0.02)
            for (t = 0; t < 1; t += inc) {
                strokeWeight(3)
                px1 = (1 - t) * x2 + (t * x3);
                py1 = (1 - t) * y2 + (t * y3);
                line(x1, y1, px1, py1)
            }
        }

        function dive(x1, y1, x2, y2, x3, y3, p) {
            if (p < 3) {
                let px1, py1, px2, py2;
                strokeWeight(3);
                var iter = Math.floor(random(3, 7));
                for (i = 0; i < iter; i++) {
                    var coin = Math.floor(random(3));
                    switch (coin) {
                        case 0:
                            px1 = 0.5 * x1 + (0.5 * x2);
                            py1 = 0.5 * y1 + (0.5 * y2);
                            px2 = 0.5 * x1 + (0.5 * x3);
                            py2 = 0.5 * y1 + (0.5 * y3);

                            citydense(x1, y1, px1, py1, px2, py2)
                            dive(x1, y1, px1, py1, px2, py2, p + 1);
                            break;
                        case 1:
                            px1 = 0.5 * x2 + (0.5 * x1);
                            py1 = 0.5 * y2 + (0.5 * y1);
                            px2 = 0.5 * x2 + (0.5 * x3);
                            py2 = 0.5 * y2 + (0.5 * y3);

                            citydense(px1, py1, x2, y2, px2, py2)

                            dive(px1, py1, x2, y2, px2, py2, p + 1);
                            break;
                        case 2:
                            px1 = 0.5 * x3 + (0.5 * x2);
                            py1 = 0.5 * y3 + (0.5 * y2);
                            px2 = 0.5 * x3 + (0.5 * x1);
                            py2 = 0.5 * y3 + (0.5 * y1);

                            citydense(px1, py1, px2, py2, x3, y3)

                            dive(px1, py1, px2, py2, x3, y3, p + 1);
                            break;
                    }
                }
            }
        }

        function diveall(x1, y1, x2, y2, x3, y3, p) {
            let density = 0.7
            if (p < 2) {
                let px1, py1, px2, py2, px3, py3;
                px1 = 0.5 * x1 + (0.5 * x2);
                py1 = 0.5 * y1 + (0.5 * y2);
                px2 = 0.5 * x1 + (0.5 * x3);
                py2 = 0.5 * y1 + (0.5 * y3);

                if(random()<density){citydense(x1, y1, px1, py1, px2, py2)}

                diveall(x1, y1, px1, py1, px2, py2, p + 1)

                px1 = 0.5 * x2 + (0.5 * x1);
                py1 = 0.5 * y2 + (0.5 * y1);
                px2 = 0.5 * x2 + (0.5 * x3);
                py2 = 0.5 * y2 + (0.5 * y3);

                if(random()<density){citydense(px1, py1, x2, y2, px2, py2)}

                diveall(px1, py1, x2, y2, px2, py2, p + 1)

                px1 = 0.5 * x3 + (0.5 * x2);
                py1 = 0.5 * y3 + (0.5 * y2);
                px2 = 0.5 * x3 + (0.5 * x1);
                py2 = 0.5 * y3 + (0.5 * y1);

                if(random()<density){citydense(px1, py1, px2, py2, x3, y3)}

                diveall(px1, py1, px2, py2, x3, y3, p + 1)

                px3 = 0.5 * x2 + (0.5 * x1);
                py3 = 0.5 * y2 + (0.5 * y1);
                if(random()<density){citydense(px1, py1, px2, py2, px3, py3)}

                diveall(px1, py1, px2, py2, px3, py3, p + 1)
                //corerays(px1,py1,px2,py2,px3,py3)
            }
        }

    </script>
</body>

</html>